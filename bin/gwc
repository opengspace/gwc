#!/usr/bin/env bash
set -e

# ===== åŸºç¡€æ ¡éªŒ =====
git rev-parse --git-dir >/dev/null 2>&1 || {
  echo "âŒ Not a git repository"
  exit 1
}

current_branch=$(git branch --show-current)
[ -z "$current_branch" ] && echo "âŒ No current branch" && exit 1

echo "å½“å‰åˆ†æ”¯: $current_branch"

# ===== commit =====
read -p "è¯·è¾“å…¥ commit message: " commit_msg
[ -z "$commit_msg" ] && echo "âŒ commit message ä¸èƒ½ä¸ºç©º" && exit 1

git add -A
git commit -m "$commit_msg"
git push origin "$current_branch"

# ===== æ–°åˆ†æ”¯ =====
read -p "æ˜¯å¦åˆ›å»ºæ–°åˆ†æ”¯ç»§ç»­å¼€å‘ï¼Ÿ(y/n): " create_new

if [[ "$create_new" =~ ^[Yy]$ ]]; then
  date_prefix=$(date +"%y%m%d")
  default_prefix="feat/${date_prefix}_"

  git fetch origin || return 1
  git pull origin || return 1
  echo "âœ… main å·²æ›´æ–°åˆ°æœ€æ–°"

  read -p "è¯·è¾“å…¥æ–°åˆ†æ”¯åï¼ˆé»˜è®¤å‰ç¼€ ${default_prefix}ï¼‰: " branch_input
  [ -z "$branch_input" ] && echo "âŒ åˆ†æ”¯åä¸èƒ½ä¸ºç©º" && exit 1

  if [[ "$branch_input" == */* ]]; then
    new_branch="$branch_input"
  else
    new_branch="${default_prefix}${branch_input}"
  fi

  git switch -c "$new_branch" b main
  echo "ğŸš€ å·²åˆ‡æ¢åˆ° $new_branch"
fi

